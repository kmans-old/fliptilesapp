<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FTA60T</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#151a20; --muted:#8aa0b3; --text:#eaf2f9; --accent:#0ea5e9;
      --tile:#0f141a; --tile-border:#6a8096; --hud-bg: rgba(17,24,39,.64); --hud-border: rgba(200,215,230,.60);
      --shadow-front: 0 16px 40px rgba(0,0,0,.82), 0 0 0 2.8px rgba(255,255,255,.42);
      --shadow-back:  0 24px 64px rgba(0,0,0,.94), 0 0 0 2.8px rgba(255,255,255,.46);

      --wrap-max:2200px; --chip:28px; --icon:26px; --gap:1px;
      --focus-ring-shadow: 0 0 0 3px var(--accent);

      /* HT layout (compact) */
      --ht-group-min: 260px;
      --ht-gap: 4px;
      --ht-inner-gap: 8px;

      /* Toolbar compact (donker) */
      --tb-bg: color-mix(in oklab, var(--panel) 92%, transparent);
      --tb-chip: #1b2430;
      --tb-font: 0.86rem;
      --tb-pad-y: .46rem;
      --tb-pad-x: .58rem;
      --tb-radius: .65rem;
    }
    .light{
      --bg:#f7fafc; --panel:#ffffff; --muted:#52616f; --text:#0b1321; --accent:#0ea5e9; --tile:#ffffff; --tile-border:#c9d3dd;
      --hud-bg: rgba(255,255,255,.96); --hud-border: rgba(0,0,0,.38);
      --shadow-front: 0 6px 18px rgba(0,0,0,.18), 0 0 0 2px rgba(0,0,0,.22);
      --shadow-back:  0 10px 26px rgba(0,0,0,.26), 0 0 0 2px rgba(0,0,0,.26);

      /* Toolbar chips: zichtbaar lichtgrijs */
      --tb-bg: color-mix(in oklab, var(--panel) 90%, transparent);
      --tb-chip: #e9eef3;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;
      background:var(--bg); color:var(--text);
      -webkit-text-size-adjust:100%;
    }

    button, .btn, .icon, input, select { touch-action: manipulation; }
    .btn, .icon { -webkit-tap-highlight-color: rgba(0,0,0,0); }

    /* ===== Toolbar ===== */
    .toolbar{
      position:fixed; top:0; left:0; right:0; z-index:4000;
      display:flex; flex-wrap:wrap; gap:.42rem; align-items:center;
      padding:.55rem .65rem;
      border-bottom:1px solid var(--tile-border);
      background:var(--tb-bg);
      backdrop-filter:blur(6px);
    }
    .label,.btn,select.label,input[type="text"].label,input[type="number"].label{
      appearance:none;
      border:none;
      background:var(--tb-chip);
      color:var(--text);
      padding: var(--tb-pad-y) var(--tb-pad-x);
      border-radius: var(--tb-radius);
      font-size: var(--tb-font);
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      box-shadow:none;
    }
    .label{ font-weight:650; cursor:default }
    .btn, input.label, select.label{ cursor:pointer }
    .btn:hover{ filter:brightness(1.06) }
    .btn.is-focused, .btn:focus, .btn:focus-visible,
    input.label:focus, input.label:focus-visible,
    select.label:focus, select.label:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
      box-shadow: var(--focus-ring-shadow);
    }
    .spacer{ flex:1 }
    .statusPill{
      border:none;
      background:var(--tb-chip);
      color:var(--muted);
      padding: var(--tb-pad-y) var(--tb-pad-x);
      border-radius: var(--tb-radius);
      font-size: var(--tb-font);
      line-height:1;
      white-space:nowrap;
      box-shadow:none;
    }
    .label::placeholder{
      color: color-mix(in oklab, var(--text) 45%, transparent);
      opacity:1;
    }

    .wrap{ max-width:var(--wrap-max); margin:0 auto; padding:.75rem; }
    body.has-fixed-toolbar .wrap{ padding-top:calc(var(--toolbar-h,72px) + .75rem); }

    /* ===== HT grid ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--ht-group-min), 1fr));
      gap: var(--ht-gap);
      align-items:start;
    }
    .htGroup{
      border:2px solid var(--tile-border);
      border-radius:14px;
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      overflow:hidden;
    }
    .htHeader{
      font-weight:800;
      text-align:center;
      padding:.55rem .5rem;
      border-bottom:2px solid var(--tile-border);
      color: color-mix(in oklab, var(--accent) 75%, var(--text));
      background: color-mix(in oklab, var(--panel) 88%, transparent);
      user-select:none;
    }
    .htInner{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--ht-inner-gap);
      padding: var(--ht-inner-gap);
      align-items:start;
    }

    /* ===== Tiles ===== */
    .tile{
      width:100%; aspect-ratio:1;
      background:var(--tile);
      border:2px solid var(--tile-border);
      border-radius:14px;
      position:relative;
      user-select:none;
      box-shadow: var(--shadow-front);
    }
    .tile.flipped{ box-shadow: var(--shadow-back); }

    .face{ position:absolute; inset:0; border-radius:14px; overflow:hidden }
    .front{ display:block; }
    .back{ display:none; }
    .tile.flipped .front{ display:none; }
    .tile.flipped .back { display:flex; flex-direction:column; }

    .hudWrap{ position:absolute; left:4px; right:4px; bottom:4px; z-index:7; }
    .hud{
      display:grid;
      grid-template-columns:repeat(6, var(--chip));
      column-gap:var(--gap);
      align-items:center;
      justify-content:flex-start;
      transform-origin:bottom left;
    }
    .chip,.icon,.ghost{
      width:var(--chip); height:var(--chip);
      border:2px solid var(--hud-border);
      background:var(--hud-bg);
      color:var(--text);
      border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      box-sizing:border-box;
    }
    .ghost{ visibility:hidden }
    .icon{ cursor:pointer; padding:0; }
    .icon svg{ width:18px; height:18px; transform:none; transform-origin:center; display:block }
    .icon.is-focused,.icon:focus,.icon:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
      box-shadow: var(--focus-ring-shadow);
    }
    .number{ font-weight:800; font-size:14px; line-height:1; min-width:var(--chip); text-align:center }

    .photo{ width:100%; height:100%; object-fit:cover; display:block }

    .back textarea{
      flex:1; resize:none;
      padding:.6rem .6rem calc(var(--chip) + 14px);
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font:inherit;
    }
    .back textarea:focus{
      outline:2px solid var(--accent);
      outline-offset:2px;
      box-shadow: var(--focus-ring-shadow);
    }

    input[type=file]{ display:none !important; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; place-items:center; z-index:5000 }
    .modal.open{ display:grid }
    .modal img{ max-width:min(92vw,1400px); max-height:90vh; border-radius:12px }

    /* Tekstlijst */
    #textlist{ display:none; padding:.6rem .25rem 1rem .25rem }
    #textlist h2{ margin:.2rem 0 .8rem 0 }
    body.rows-35 #textlist{ font-size:13.2px }
    body.rows-35 .page{ margin:0 0 18px 0; padding:0; }
    body.rows-35 .pageHeader{ font-weight:700; margin:0 0 8px 0; color:var(--muted); font-size:.9rem }
    body.rows-35 .twoCols{ display:grid; grid-template-columns:1fr 1fr; gap:22px }
    body.rows-35 ol.col{ margin:0; padding-left:0 !important; list-style:none !important }
    body.rows-35 li{ margin:0; padding:.32em 0; border-bottom:1px solid color-mix(in oklab, var(--text) 50%, transparent) }

    @media print{
      .toolbar,#modal{ display:none !important }
      body.has-fixed-toolbar .wrap{ padding-top:0 }
      @page{ size:A4; margin:10mm }
      body.rows-35 #textlist{ font-size:10.5pt }
      body.rows-35 li{ padding:.14em 0 }
      body.rows-35 .page{ break-after:page; margin:0; }
      body.rows-35 .pageHeader{ display:none }
      body.rows-35 .twoCols{ gap:14mm }
    }

    body:not(.light) .tile{
      border-color:#9fb4ca !important;
      box-shadow: 0 20px 52px rgba(0,0,0,.92), 0 0 0 3px rgba(255,255,255,.55) !important;
    }
    body:not(.light) .tile.flipped{
      box-shadow: 0 26px 68px rgba(0,0,0,.96), 0 0 0 3px rgba(255,255,255,.60) !important;
    }

    .mark{
      outline:3px solid var(--accent);
      outline-offset:2px;
      box-shadow: var(--focus-ring-shadow);
    }

    @media (max-width: 560px){
      .toolbar{ flex-direction:column; align-items:stretch; }
      .spacer{ display:none; }
      .toolbar > *{ width:100%; justify-content:space-between; }
      #searchInput, #searchText{ width:100% !important; }
      .statusPill{ text-align:left; justify-content:flex-start; }
    }
  body.perf .toolbar{ backdrop-filter:none !important; }
body.perf .tile{ box-shadow:none !important; }
body.perf .tile.flipped{ box-shadow:none !important; }
body.perf .htGroup{ background: var(--panel) !important; }
  </style>
</head>

<body class="light rows-35">
  <div class="toolbar" id="toolbar" role="navigation" aria-label="Hoofdbalk">
    <span class="label" id="appLabel">FTA60T</span>
    <button class="btn" id="themeBtn" type="button">Licht/Donker</button>
    <button class="btn" id="perfBtn" type="button" title="Sneller op iPhone/iPad">Performance</button>

    <button class="btn" id="importBtn" type="button">Importeer</button>
    <input id="importInput" type="file" accept="text/html,application/json" />
    <button class="btn" id="mergeBtn" type="button">Voeg bestand toe</button>
    <button class="btn" id="saveBtn" type="button">Opslaan</button>

    <button class="btn" id="undoBtn" type="button" title="Undo (Ctrl/Cmd+Z)">Undo</button>

    <div class="spacer"></div>

    <button class="btn" id="allFrontBtn" type="button">Alles foto</button>
    <button class="btn" id="allBackBtn" type="button">Alles tekst</button>

    <div class="spacer"></div>

    <button class="btn" id="showGridBtn" type="button">Tegels</button>
    <button class="btn" id="showListBtn" type="button">Lijst</button>

    <span class="statusPill" id="statusPill">Tegels: 0 • Foto’s: 0 • Teksten: 0</span>

    <div class="spacer"></div>

    <input id="searchInput" type="number" min="1" placeholder="Zoek tegel #" class="label" style="width:8rem" />
    <button class="btn" id="searchBtn" type="button">Zoek</button>

    <input id="searchText" type="text" placeholder="Zoek tekst…" class="label" style="width:14rem" />
    <button class="btn" id="searchTextBtn" type="button">Vind</button>
    <button class="btn" id="searchNextBtn" type="button" title="Volgende match">Volgende</button>
    <button class="btn" id="searchPrevBtn" type="button" title="Vorige match">Vorige match</button>
  </div>

  <div class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
    <section id="textlist">
      <h2>Genummerde tekstlijst</h2>
      <div id="textlistPages" aria-label="Tekstlijst pagina's"></div>
    </section>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Vergrote foto">
    <img id="modalImg" alt="" />
  </div>

<script>
(function(){
  'use strict';

  const TILE_COUNT = 60;
  const GROUPS = 6;
  const PER_GROUP = 10;

  const grid = document.getElementById('grid');
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modalImg');
  const textlistPages = document.getElementById('textlistPages');
  const textlist = document.getElementById('textlist');
  const toolbar = document.getElementById('toolbar');
  const statusPill = document.getElementById('statusPill');
  const undoBtn = document.getElementById('undoBtn');

  const UI_KEY = 'fta60-ui';

  const undoStack = [];
  const UNDO_LIMIT = 50;

  let textMatches = [];
  let textMatchIndex = -1;

  function syncToolbarPadding(){
    const h = Math.ceil(toolbar.getBoundingClientRect().height);
    document.body.style.setProperty('--toolbar-h', h+'px');
    document.body.classList.add('has-fixed-toolbar');
  }
  window.addEventListener('load', syncToolbarPadding);
  new ResizeObserver(syncToolbarPadding).observe(toolbar);

  function filenameBase(){
    try{
      const p = decodeURIComponent(location.pathname.split('/').pop()||'');
      return p.replace(/\.html?$/i,'');
    }catch(_){ return ''; }
  }
  function nextSuffix(base){
    const m = base.match(/^(.*?)-(\d+)$/);
    if(m) return m[1]+'-'+(parseInt(m[2],10)+1);
    return base+'-1';
  }

  function safeStorageGet(key){ try{ return localStorage.getItem(key); }catch(_){ return null; } }
  function safeStorageSet(key,val){ try{ localStorage.setItem(key,val); return true; }catch(_){ return false; } }

  function saveUI(patch){
    try{
      const cur = loadUI(true) || {};
      const next = Object.assign({}, cur, patch || {});
      next.theme = document.body.classList.contains('light') ? 'light' : 'dark';
      next.perf = document.body.classList.contains('perf');
      safeStorageSet(UI_KEY, JSON.stringify(next));
    }catch(_){}
  }
  function loadUI(returnOnly){
    try{
      const raw = safeStorageGet(UI_KEY);
      const u = raw ? JSON.parse(raw) : {};
      if(returnOnly) return u;

      if(u.theme) document.body.classList.toggle('light', u.theme==='light');

      if(typeof u.perf === 'boolean') document.body.classList.toggle('perf', !!u.perf);
if(u.view === 'list') {
        grid.style.display='none';
        textlist.style.display='block';
      } else {
        grid.style.display='grid';
        textlist.style.display='none';
      }

      if(typeof u.lastTextQuery === 'string'){
        document.getElementById('searchText').value = u.lastTextQuery;
      }
      return u;
    }catch(_){
      if(returnOnly) return {};
      grid.style.display='grid';
      textlist.style.display='none';
      return {};
    }
  }

  function setTheme(mode){
    document.body.classList.toggle('light', mode==='light');
    saveUI();
  }
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    const toLight = !document.body.classList.contains('light');
    setTheme(toLight ? 'light' : 'dark');
  });

  
  document.getElementById('perfBtn').addEventListener('click', ()=>{
    document.body.classList.toggle('perf');
    saveUI();
  });
function showGrid(){
    grid.style.display='grid';
    textlist.style.display='none';
    saveUI({ view:'grid' });
  }
  function showList(){
    fillTextList();
    grid.style.display='none';
    textlist.style.display='block';
    saveUI({ view:'list' });
  }
  document.getElementById('showGridBtn').addEventListener('click', showGrid);
  document.getElementById('showListBtn').addEventListener('click', showList);

  function clearMarks(){ grid.querySelectorAll('.tile.mark').forEach(t=> t.classList.remove('mark')); }
  function markTile(tile){
    clearMarks();
    if(!tile) return;
    tile.classList.add('mark');
    tile.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=> tile.classList.remove('mark'), 6000);
  }
  function doSearchNumber(){
    const n = parseInt(document.getElementById('searchInput').value,10);
    if(!n) return;
    const tile = grid.querySelectorAll('.tile')[n-1];
    if(tile) markTile(tile);
  }
  document.getElementById('searchBtn').addEventListener('click', doSearchNumber);
  document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearchNumber(); });

  const searchTextEl = document.getElementById('searchText');
  document.getElementById('searchTextBtn').addEventListener('click', doFindText);
  document.getElementById('searchNextBtn').addEventListener('click', ()=> stepTextMatch(1));
  document.getElementById('searchPrevBtn').addEventListener('click', ()=> stepTextMatch(-1));
  searchTextEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doFindText(); });

  function buildTextMatches(q){
    const tiles = [...grid.querySelectorAll('.tile')];
    return tiles
      .map((t, idx)=>({ t, idx, text:(t.querySelector('.back textarea').value||'') }))
      .filter(o => o.text.toLowerCase().includes(q));
  }
  function doFindText(){
    const q = (searchTextEl.value||'').toLowerCase().trim();
    saveUI({ lastTextQuery: searchTextEl.value||'' });
    if(!q){ textMatches=[]; textMatchIndex=-1; return; }
    textMatches = buildTextMatches(q);
    textMatchIndex = (textMatches.length ? 0 : -1);
    if(textMatchIndex>=0) markTile(textMatches[textMatchIndex].t);
  }
  function stepTextMatch(dir){
    if(!textMatches.length){
      doFindText();
      if(!textMatches.length) return;
    }
    textMatchIndex = (textMatchIndex + dir + textMatches.length) % textMatches.length;
    markTile(textMatches[textMatchIndex].t);
  }

  const importInput=document.getElementById('importInput');
  document.getElementById('importBtn').addEventListener('click',()=>{ importInput.onchange = (e)=> handleFile(e,false); importInput.click(); });
  document.getElementById('mergeBtn').addEventListener('click',()=>{ importInput.onchange = (e)=> handleFile(e,true); importInput.click(); });

  function handleFile(e, merge){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const text = r.result;
        if(/text\/html/.test(file.type)){
          const m = text.match(/<script id="__STATE__" type="application\/json">([\s\S]*?)<\/script>/);
          if(!m) return alert('Geen ingesloten gegevens gevonden.');
          const data = JSON.parse(m[1]);
          merge ? mergeData(data) : importData(data);
        } else {
          const data = JSON.parse(text);
          merge ? mergeData(data) : importData(data);
        }
      }catch(err){
        console.error(err);
        alert('Kon het bestand niet lezen.');
      }
      importInput.value='';
    };
    r.readAsText(file);
  }

  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const base = filenameBase() || (document.getElementById('appLabel')?.textContent) || 'fta60t';
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    const stamp = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + '-' + pad(now.getHours()) + pad(now.getMinutes());
    const nextName = base + '-' + stamp;
    const state = exportData();
    state.name = nextName;
    const blob = new Blob([buildSingleFileHTML(state)],{type:'text/html'});
    const a = document.createElement('a');
    a.download = nextName + '.html';
    a.href = URL.createObjectURL(blob);
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

const a = document.createElement('a');
    a.download = nextName + '.html';
    a.href = URL.createObjectURL(blob);
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  undoBtn.addEventListener('click', undo);
  window.addEventListener('keydown', (e)=>{
    const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && e.key.toLowerCase()==='z'){
      e.preventDefault();
      undo();
    }
  });

  function pushUndo(action){
    undoStack.push(action);
    if(undoStack.length > UNDO_LIMIT) undoStack.shift();
    updateUndoButton();
  }
  function updateUndoButton(){
    if(!undoStack.length){
      undoBtn.textContent = 'Undo';
      undoBtn.disabled = true;
      undoBtn.style.opacity = '0.65';
      return;
    }
    undoBtn.disabled = false;
    undoBtn.style.opacity = '1';
    undoBtn.textContent = `Undo (${undoStack.length})`;
  }
  function undo(){
    const a = undoStack.pop();
    updateUndoButton();
    if(!a) return;
    if(a.type === 'clearTile'){
      const tiles = [...grid.querySelectorAll('.tile')];
      const t = tiles[a.index];
      if(t){
        applyTileData(t, a.data);
        renumber(); autoscaleAllHUD(); updateStatus();
      }
    }
  }

  document.getElementById('allFrontBtn').addEventListener('click', ()=> setAllSides('front'));
  document.getElementById('allBackBtn').addEventListener('click',  ()=> setAllSides('back'));

  function setAllSides(side){
    grid.querySelectorAll('.tile').forEach(t=>{
      if(side==='front') t.classList.remove('flipped');
      else t.classList.add('flipped');
    });
  }

  function clearTile(tile){
    const img=tile.querySelector('.front .photo');
    if(img){ img.removeAttribute('src'); img.style.display='none'; }
    const ta=tile.querySelector('.back textarea');
    if(ta){ ta.value=''; }
  }
  function readTileData(tile){
    const img = tile.querySelector('.front .photo');
    const ta  = tile.querySelector('.back textarea');
    return {
      image: (img && img.src) ? img.src : '',
      text: (ta && ta.value) ? ta.value : '',
      flipped: tile.classList.contains('flipped')
    };
  }
  function applyTileData(tile, data){
    const img = tile.querySelector('.front .photo');
    const ta  = tile.querySelector('.back textarea');
    if(img){
      if(data.image){
        img.src = data.image;
        img.style.display='block';
      }else{
        img.removeAttribute('src');
        img.style.display='none';
      }
    }
    if(ta) ta.value = data.text || '';
    tile.classList.toggle('flipped', !!data.flipped);
  }

  function buildHTSkeleton(){
    grid.innerHTML='';
    const HEADERS = ["vat-G", "vat-M", "vat-K", "bak-G", "bak-K", "Tuintje"];
    for(let g=1; g<=GROUPS; g++){
      const group = el('div',{class:'htGroup', 'data-ht': String(g)});
      const label = HEADERS[g-1] || ('Kolom '+g);
      const head  = el('div',{class:'htHeader'}, label);
      const inner = el('div',{class:'htInner'});
      group.append(head, inner);
      grid.append(group);
    }
  }
  function groupInnerForTileIndex(idx){
    const g = Math.floor(idx / PER_GROUP);
    const group = grid.querySelectorAll('.htGroup')[g];
    return group ? group.querySelector('.htInner') : null;
  }
  function addTile(n){
    const tile = createTile(n);
    const idx = n-1;
    const inner = groupInnerForTileIndex(idx);
    if(inner) inner.appendChild(tile);
  }

  function createTile(n){
    const tile=el('div',{class:'tile'});
    const front=el('div',{class:'face front'});
    const img=el('img',{class:'photo',alt:'',decoding:'async',loading:'lazy',style:'display:none'});
    img.addEventListener('error', ()=>{ img.style.display='none'; img.removeAttribute('src'); });

    const hudWrapF=el('div',{class:'hudWrap'});
    const hudF=el('div',{class:'hud'});
    const fin=el('input',{type:'file',accept:'image/*'});

    hudF.append(el('div',{class:'chip number'}, String(n)));
    hudF.append(iconBtn('Foto kiezen',cameraSVG(),()=> fin.click()));
    hudF.append(iconBtn('Vergroten',magnifierSVG(),()=>{
      if(img.src){
        modalImg.src = img.src;
        modal.classList.add('open');
      }
    }));
    hudF.append(iconBtn('Flip naar tekst',flipSVG(),()=> tile.classList.add('flipped')));
    hudF.append(iconBtn('Tegel leegmaken',trashSVG(),()=>{
      const idx = [...grid.querySelectorAll('.tile')].indexOf(tile);
      pushUndo({ type:'clearTile', index: idx, data: readTileData(tile) });
      clearTile(tile);
      renumber(); autoscaleAllHUD(); updateStatus();
    }));
    hudF.append(el('div',{class:'ghost'}));
    hudWrapF.append(hudF);

    fin.addEventListener('change',(e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        img.src=r.result;
        img.style.display='block';
        autoscaleHUD(tile);
        updateStatus();
      };
      r.readAsDataURL(f);
      fin.value='';
    });

    front.append(img,hudWrapF,fin);

    const back=el('div',{class:'face back'});
    const ta=el('textarea',{placeholder:'Tekst…'});
    ta.addEventListener('input', ()=>{ updateStatus(); });

    const hudWrapB=el('div',{class:'hudWrap'});
    const hudB=el('div',{class:'hud'});
    hudB.append(
      el('div',{class:'chip number'}, String(n)),
      el('div',{class:'ghost'}),
      el('div',{class:'ghost'}),
      iconBtn('Terug naar foto',flipSVG(),()=> tile.classList.remove('flipped')),
      iconBtn('Tegel leegmaken',trashSVG(),()=>{
        const idx = [...grid.querySelectorAll('.tile')].indexOf(tile);
        pushUndo({ type:'clearTile', index: idx, data: readTileData(tile) });
        clearTile(tile);
        renumber(); autoscaleAllHUD(); updateStatus();
      }),
      el('div',{class:'ghost'})
    );
    hudWrapB.append(hudB);
    back.append(ta,hudWrapB);

    tile.append(front,back);
    return tile;
  }

  function el(tag,attrs,...kids){
    const node=document.createElement(tag);
    if(attrs){ for(const k in attrs) node.setAttribute(k, attrs[k]); }
    kids.forEach(k=> node.append(k && k.nodeType? k : document.createTextNode(k)));
    return node;
  }
  function iconBtn(title,svg,onClick){
    const b=el('button',{class:'icon',title,tabindex:'0',type:'button'});
    b.innerHTML=svg;
    b.addEventListener('click',(e)=>{ e.stopPropagation(); onClick&&onClick(); });
    b.addEventListener('mousedown',()=>{ try{ b.classList.add('is-focused'); }catch(_e){} });
    return b;
  }

  modal.addEventListener('click', ()=> modal.classList.remove('open'));
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') modal.classList.remove('open'); });

  function autoscaleHUD(tile){
    const huds = tile.querySelectorAll('.hudWrap .hud');
    if(!huds.length) return;
    const cs = getComputedStyle(document.documentElement);
    const chip = parseFloat(cs.getPropertyValue('--chip')) || 28;
    const gap  = parseFloat(cs.getPropertyValue('--gap'))  || 1;
    const expected = 6*chip + 5*gap;
    const available = tile.clientWidth - 8;
    const scale = Math.min(1, available / expected);
    huds.forEach(h => { h.style.transformOrigin='bottom left'; h.style.transform=`scale(${scale})`; });
    tile.querySelectorAll('.chip.number').forEach(c=>{
      const v=c.textContent.trim();
      c.style.fontSize=(v.length>=3?'12px':'14px');
    });
  }
  function autoscaleAllHUD(){ grid.querySelectorAll('.tile').forEach(autoscaleHUD); }
  new ResizeObserver(()=> autoscaleAllHUD()).observe(document.querySelector('.wrap'));

  function renumber(){
    grid.querySelectorAll('.tile').forEach((t,i)=>{
      t.querySelectorAll('.chip.number').forEach(n=> n.textContent = i+1);
      t.setAttribute('aria-label','Tegel '+(i+1));
      autoscaleHUD(t);
    });
    if(textlist.style.display==='block') fillTextList();
    updateStatus();
  }

  function fillTextList(){
    const HEADERS = ["vat-G", "vat-M", "vat-K", "bak-G", "bak-K", "Tuintje"];
    const perCol = 35;
    const perPage = perCol * 2;
    const tiles=[...grid.querySelectorAll('.tile')];
    textlistPages.innerHTML='';
    const pageCount = Math.max(1, Math.ceil(tiles.length / perPage));
    for(let p=0; p<pageCount; p++){
      const page = document.createElement('div');
      page.className = 'page';
      const header = document.createElement('div');
      header.className = 'pageHeader';
      const startNr = p*perPage + 1;
      const endNr = Math.min((p+1)*perPage, tiles.length);
      header.textContent = `Pagina ${p+1} (nrs ${startNr}–${Math.max(endNr, startNr)})`;
      const cols = document.createElement('div');
      cols.className = 'twoCols';
      const olL = document.createElement('ol'); olL.className='col';
      const olR = document.createElement('ol'); olR.className='col';

      for(let i=0;i<perCol;i++){
        const idx = p*perPage + i;
        const li = document.createElement('li');
        const nr = idx + 1;
        const text = (idx < tiles.length) ? (tiles[idx].querySelector('.back textarea').value || '') : '';
                const colNr = Math.floor(idx / PER_GROUP) + 1;
        const inCol = (idx % PER_GROUP) + 1;
        const label = (HEADERS[colNr-1] || ('Kolom '+colNr)) + ' ' + inCol;
        li.textContent = `${label}: ${text}`;
        olL.appendChild(li);
      }
      for(let i=0;i<perCol;i++){
        const idx = p*perPage + perCol + i;
        const li = document.createElement('li');
        const nr = idx + 1;
        const text = (idx < tiles.length) ? (tiles[idx].querySelector('.back textarea').value || '') : '';
                const colNr = Math.floor(idx / PER_GROUP) + 1;
        const inCol = (idx % PER_GROUP) + 1;
        const label = (HEADERS[colNr-1] || ('Kolom '+colNr)) + ' ' + inCol;
        li.textContent = `${label}: ${text}`;
        olR.appendChild(li);
      }

      cols.appendChild(olL); cols.appendChild(olR);
      page.appendChild(header); page.appendChild(cols);
      textlistPages.appendChild(page);
    }
  }

  function updateStatus(){
    const tiles = [...grid.querySelectorAll('.tile')];
    let photos=0, texts=0;
    tiles.forEach(t=>{
      const img=t.querySelector('.front .photo');
      if(img && img.src) photos++;
      const tx=t.querySelector('.back textarea')?.value || '';
      if(tx.trim().length) texts++;
    });
    statusPill.textContent = `Tegels: ${tiles.length} • Foto’s: ${photos} • Teksten: ${texts}`;
    if(undoStack.length){
      undoBtn.style.boxShadow = '0 0 0 2px color-mix(in oklab, var(--accent) 30%, transparent)';
    }else{
      undoBtn.style.boxShadow = '';
    }
  }

  function mergeData(data){
    if(!data||!data.items) return;
    const tiles=[...grid.querySelectorAll('.tile')];
    const freeIdx=[];
    tiles.forEach((t,i)=>{
      const img=t.querySelector('.front .photo');
      const tx=t.querySelector('.back textarea')?.value || '';
      const empty = !(img && img.src) && !tx.trim();
      if(empty) freeIdx.push(i);
    });
    let w=0;
    for(let i=0;i<data.items.length;i++){
      if(w>=freeIdx.length) break;
      const it=data.items[i] || {};
      if(!it.image && !(it.text||'').trim()) continue;
      const t=tiles[freeIdx[w++]];
      applyTileData(t, it);
      autoscaleHUD(t);
    }
    renumber(); autoscaleAllHUD(); updateStatus();
  }

  function exportData(){
    const items=[];
    grid.querySelectorAll('.tile').forEach(t=>{
      const img=t.querySelector('.front .photo');
      const text=t.querySelector('.back textarea').value || '';
      items.push({
        image: (img && img.src)? img.src : '',
        text,
        flipped: t.classList.contains('flipped')
      });
    });
    const name=(document.getElementById('appLabel')?.textContent)||'FTA60';
    return { name, version:'fta60', theme: document.body.classList.contains('light')? 'light':'dark', items };
  }

  function importData(data){
    if(!data||!data.items) return;
    buildHTSkeleton();
    for(let i=1;i<=TILE_COUNT;i++) addTile(i);
    const tiles=[...grid.querySelectorAll('.tile')];
    for(let i=0;i<Math.min(TILE_COUNT, data.items.length);i++){
      applyTileData(tiles[i], data.items[i] || {});
      autoscaleHUD(tiles[i]);
    }
    if(data.theme){ setTheme(data.theme); }
    undoStack.length = 0;
    updateUndoButton();
    renumber(); autoscaleAllHUD(); updateStatus();
  }

  function buildSingleFileHTML(state){
    const tpl=document.documentElement.cloneNode(true);
    tpl.querySelectorAll('#__STATE__').forEach(n=>n.remove());
    const g=tpl.querySelector('#grid'); if(g) g.innerHTML='';
    const s=document.createElement('script');
    s.id='__STATE__'; s.type='application/json';
    s.textContent=JSON.stringify(state);
    const body=tpl.querySelector('body');
    if(body){ body.insertBefore(s, body.firstChild); }
    return '<!DOCTYPE html>\n'+tpl.outerHTML;
  }

  // INIT: always build tiles first
  (function init(){
    const base = filenameBase();
    if(base){
      document.title = base;
      const lab = document.getElementById('appLabel');
      if(lab) lab.textContent = base.toUpperCase();
    }

    buildHTSkeleton();
    for(let i=1;i<=TILE_COUNT;i++) addTile(i);
    renumber(); autoscaleAllHUD(); updateStatus();

    try{ loadUI(); }catch(_){}

    // embedded state (if present)
    try{
      const embedded=document.getElementById('__STATE__');
      if(embedded){
        const data=JSON.parse(embedded.textContent||'{}');
        if(data && data.items) importData(data);
      }
    }catch(_){}

    syncToolbarPadding();
    updateUndoButton();
  })();

  // focus helpers
  (function(){
    function clearToolbarFocus(){ toolbar.querySelectorAll('.btn.is-focused').forEach(b=> b.classList.remove('is-focused')); }
    toolbar.addEventListener('mousedown', (e)=>{ const b=e.target.closest?.('.btn'); if(b){ clearToolbarFocus(); b.classList.add('is-focused'); } });
    document.addEventListener('mousedown', (e)=>{ if(!e.target.closest('#toolbar')) clearToolbarFocus(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Tab'){ setTimeout(()=>{ clearToolbarFocus(); const a=document.activeElement; if(a?.classList?.contains('btn')) a.classList.add('is-focused'); },0); } });
  })();
  (function(){
    function clearIconFocus(){ document.querySelectorAll('.icon.is-focused').forEach(el=> el.classList.remove('is-focused')); }
    document.addEventListener('mousedown', (e)=>{
      const ico = e.target.closest && e.target.closest('.icon');
      if(ico){ clearIconFocus(); ico.classList.add('is-focused'); }
      else { clearIconFocus(); }
    });
  })();

})();
function cameraSVG(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1"><path d="M5 7h3l2-2h4l2 2h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z"/><circle cx="12" cy="13" r="3.8"/></svg>'; }
function magnifierSVG(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><circle cx="11" cy="11" r="6.6"/><path d="M20 20l-4.2-4.2" stroke-linecap="round"/></svg>'; }
function flipSVG(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><path d="M7 7h7a3 3 0 0 1 3 3v1"/><path d="M17 5v6m0 0-2-2m2 2 2-2"/><path d="M17 17H10a 3 3 0 0 1-3-3v-1"/><path d="M7 19v-6m0 0 2 2m-2-2-2 2"/></svg>'; }
function trashSVG(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><path d="M4 6h16M6 6l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13"/><path d="M9.5 10.5v7M14.5 10.5v7"/></svg>'; }
</script>
</body>
</html>
